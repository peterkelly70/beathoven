#!/bin/bash
set -euo pipefail

BRANCH="iterations"

# Ensure we're on the correct branch
git checkout "$BRANCH" || { echo "âŒ Could not checkout branch '$BRANCH'"; exit 1; }

# Check for uncommitted work
if ! git diff-index --quiet HEAD --; then
  echo "ğŸš« Uncommitted changes in '$BRANCH'. Please commit or stash them before cleaning."
  exit 1
fi

# Backup
timestamp=$(date +%Y%m%d-%H%M)
backup_branch="${BRANCH}-backup-${timestamp}"
git branch "$backup_branch"
echo "ğŸ›¡ï¸  Backup created as '$backup_branch'"

# Root rebase
echo "ğŸ§¹ Starting interactive root rebase of '$BRANCH'..."
git rebase -i --root || {
  echo "âŒ Rebase failed. You can restore from '$backup_branch'."
  exit 1
}

echo "âœ… '$BRANCH' cleaned. Backup: $backup_branch"
